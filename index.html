<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:web="http://schemas.live.com/Web/" lang="en">
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <style type="text/css">
    table {
	  width: 100%;
	  table-layout: fixed;
	}
	th {
	  width: 100%;
	}
    td {
	  border-color: black;
	  border-style: solid;
	  border-width: 1px;
	  text-align: center;
	}
	.explain {
	  width: 80px;
	}
	.celldiv {
	  width:100%;
	  height:100%;
	  display:block;
	}
  </style>
</head>
<body>
<h3>Spread: <div style="display:inline" id="arb"></div></h3>
<div class="btn-toolbar mb-3" role="toolbar">
  <div class="btn-group me-2" role="group">
	<button id="btcaud" class="btn btn-outline-secondary" onclick="location.href='http://localhost:8000/#btcaud';location.reload();" type="button">BTC/AUD</button>
	<button id="usdtaud" class="btn btn-outline-secondary" onclick="location.href='http://localhost:8000/#usdtaud';location.reload()" type="button">USDT/AUD</button>
	<button id="usdcaud" class="btn btn-outline-secondary" onclick="location.href='http://localhost:8000/#usdcaud';location.reload()" type="button">USDC/AUD</button>
  </div>
  <div class="input-group">
	<div class="input-group-text" id="vt_text">Volume Threshold: </div>
	<input id="vt" placeholder="Volume Threshold" class="form-control" type="text" name="vt" />
  </div>
</div>
<table>
<thead>
  <tr>
	<th class="explain"></th>
	<th>IndependentReserve</th>
	<th>BTCMarkets</th>
	<th>Coinjar</th>
	<th>Kraken</th>
  </tr>
</thead>
<tbody>
  <tr>
	<td class="explain" rowspan="10">Ask Levels</td>
	<td id="ia9"></td>
	<td id="ba9"></td>
	<td id="ca9"></td>
	<td id="ka9"></td>
  </tr>
  <tr>
	<td id="ia8"></td>
	<td id="ba8"></td>
	<td id="ca8"></td>
	<td id="ka8"></td>
  </tr>
  <tr>
	<td id="ia7"></td>
	<td id="ba7"></td>
	<td id="ca7"></td>
	<td id="ka7"></td>
  </tr>
  <tr>
	<td id="ia6"></td>
	<td id="ba6"></td>
	<td id="ca6"></td>
	<td id="ka6"></td>
  </tr>
  <tr>
	<td id="ia5"></td>
	<td id="ba5"></td>
	<td id="ca5"></td>
	<td id="ka5"></td>
  </tr>
  <tr>
	<td id="ia4"></td>
	<td id="ba4"></td>
	<td id="ca4"></td>
	<td id="ka4"></td>
  </tr>
  <tr>
	<td id="ia3"></td>
	<td id="ba3"></td>
	<td id="ca3"></td>
	<td id="ka3"></td>
  </tr>
  <tr>
	<td id="ia2"></td>
	<td id="ba2"></td>
	<td id="ca2"></td>
	<td id="ka2"></td>
  </tr>
  <tr>
	<td id="ia1"></td>
	<td id="ba1"></td>
	<td id="ca1"></td>
	<td id="ka1"></td>
  </tr>
  <tr>
	<td id="ia0"></td>
	<td id="ba0"></td>
	<td id="ca0"></td>
	<td id="ka0"></td>
  </tr>
  <!-- last price -->
  <tr>
	<td class="explain">Last Price</td>
	<td id="il"></td>
	<td id="bl"></td>
	<td id="cl"></td>
	<td id="kl"></td>
  </tr>
  <tr>
	<td class="explain" rowspan="10">Bid Levels</td>
	<td id="ib0"></td>
	<td id="bb0"></td>
	<td id="cb0"></td>
	<td id="kb0"></td>
  </tr>
  <tr>
	<td id="ib1"></td>
	<td id="bb1"></td>
	<td id="cb1"></td>
	<td id="kb1"></td>
  </tr>
  <tr>
	<td id="ib2"></td>
	<td id="bb2"></td>
	<td id="cb2"></td>
	<td id="kb2"></td>
  </tr>
  <tr>
	<td id="ib3"></td>
	<td id="bb3"></td>
	<td id="cb3"></td>
	<td id="kb3"></td>
  </tr>
  <tr>
	<td id="ib4"></td>
	<td id="bb4"></td>
	<td id="cb4"></td>
	<td id="kb4"></td>
  </tr>
  <tr>
	<td id="ib5"></td>
	<td id="bb5"></td>
	<td id="cb5"></td>
	<td id="kb5"></td>
  </tr>
  <tr>
	<td id="ib6"></td>
	<td id="bb6"></td>
	<td id="cb6"></td>
	<td id="kb6"></td>
  </tr>
  <tr>
	<td id="ib7"></td>
	<td id="bb7"></td>
	<td id="cb7"></td>
	<td id="kb7"></td>
  </tr>
  <tr>
	<td id="ib8"></td>
	<td id="bb8"></td>
	<td id="cb8"></td>
	<td id="kb8"></td>
  </tr>
  <tr>
	<td id="ib9"></td>
	<td id="bb9"></td>
	<td id="cb9"></td>
	<td id="kb9"></td>
  </tr>
  <tr>
	<td>Timestamp</td>
	<td id="it"></td>
	<td id="bt"></td>
	<td id="ct"></td>
	<td id="kt"></td>
  </tr>
  <tr>
	<td>Volume(24h)</td>
	<td id="iv"></td>
	<td id="bv"></td>
	<td id="cv"></td>
	<td id="kv"></td>
  </tr>
</tbody>
</table>
<script>
  var vt = 0.0;
  var arb = 0.0;
  var bestbid = 1.0, bestask = 1.0;

  // volume threashold processing
  const vtInput = document.getElementById("vt");
  vtInput.addEventListener("input", (e) => {
	try {
	  if (e.target && e.target.value) {
	  	vt = parseFloat(e.target.value);
	  } else {
		vt = 0.0;
	  }
	} catch(e) {
	  console.log("error: " + e);
	  vt = 0.0;
	}
  });

  // utility to convert exchange name to id
  let e2id = (name) => {
	switch(name) {
	  	case "independentreserve": return "i";
		case "btcmarkets": return "b";
		case "coinjar": return "c";
		case "kraken": return "k";
	}
  }

  // set pair from url hash
  // if no hash, fallback to use btcaud
  var pair = (window.location.hash || "#btcaud").slice(1);
  // render the port from url hash
  let getPort = () => {
	if (pair === "btcaud") {
	  return 50051;
	} else if (pair === "usdtaud") {
	  return 50052;
	} else if (pair === "usdcaud") {
	  return 50053;
	} else {
	  throw new Error(`unsupport pair: ${pair}`);
	}
  };

  // toggle the btn-primary if the button has been selected
  let button = document.getElementById(pair);
  button.classList.toggle("btn-outline-secondary");
  button.classList.add("btn-primary");

  // determine domain.
  let domain = "170.64.200.82";
  if (window.location.hostname !== "localhost" &&
	window.location.hostname != "127.0.0.1") {
	domain = window.location.hostname;
  }

  let connect = () => {
	// create ws socket base on the rendered domain and port.
	let url = `ws://${domain}:${getPort()}/ws`;
	console.log(`connecting to ${url}...`);
	let socket = new WebSocket(url);
	socket.addEventListener("open", (event) => {
	  console.log("socket open");
	});

	// the message update will overwrite all data
	socket.addEventListener("message", (event) => {
	  let obj = JSON.parse(event.data);
	  // cleanup
	  for (let e of ["i", "b", "c", "k"]) {
		for (let i=0; i<10; i++) {
		  document.getElementById(e + "a" + i).innerHTML = "";
		  document.getElementById(e + "b" + i).innerHTML = "";
		}
		document.getElementById(e + "l").innerHTML = "";
	  }
	  for (let e in obj.timestamp) {
		  document.getElementById(e2id(e) + "t").innerHTML = obj.timestamp[e];
	  }
	  for (let v in obj.volume) {
		document.getElementById(e2id(v) + "v").innerHTML = obj.volume[v];
	  }
	  for (let p in obj.last_price) {
		document.getElementById(e2id(p) + "l").innerHTML = obj.last_price[p];
	  }
	  let countermap = {'i': 0, 'b': 0, 'c': 0, 'k': 0};
	  let index = 0;
	  for (let i=0; i<obj.bids.length; i++) {
		// dynamically create ids in the html components
		let level = obj.bids[i];
		let id = e2id(level.exchange);
		let counter = countermap[id];
		let key = id + 'b' + counter;
		countermap[id] += 1;
		let attr = "";
		if (i == index) {
		  try {
			let amount = parseFloat(level.amount);
			if (amount < vt) {
			  index += 1;
			} else {
			  attr = "background-color: green";
			  bestbid = parseFloat(level.price);
			  arb = ((bestbid / bestask) - 1.) * 100;
			  document.getElementById("arb").innerHTML = arb;
			}
		  } catch (e) {
			console.error(e);
		  }
		}
		document.getElementById(key).innerHTML = "<div class='celldiv' style='" + attr + ";'>" + level.price + " : " + level.amount + "</div>";
	  }
	  countermap = {'i': 0, 'b': 0, 'c': 0, 'k': 0};
	  index = 0;
	  for (let i=0; i<obj.asks.length; i++) {
		let level = obj.asks[i];
		let id = e2id(level.exchange);
		let counter = countermap[id];
		let key = id + 'a' + counter;
		countermap[id] += 1;
		let attr = ""
		if (i == index) {
		  try {
			let amount = parseFloat(level.amount);
			if (amount >= vt) {
			  attr = "background-color: green";
			  bestask = parseFloat(level.price);
			  arb = ((bestbid / bestask) - 1.) * 100.;
			  document.getElementById("arb").innerHTML = arb;
			} else {
			  index += 1
			}
		  } catch(e) {
			console.error(e);
		  }
		}
		document.getElementById(key).innerHTML = "<div class='celldiv' style='"+attr+";'>" + level.price + " : " + level.amount + "</span>";
	  }
	});
	socket.addEventListener("close", (event) => {
	  console.log("socket close");
	  setTimeout(() => {
		connect();
	  }, 1000);
	});
  };
  connect();
</script>
</body>
</html>
